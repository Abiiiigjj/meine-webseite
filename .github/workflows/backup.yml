name: Database Backup

on:
  schedule:
    # TÃ¤glich um 03:00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    # Manueller Trigger fÃ¼r Tests

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Create Database Backup
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          # Extrahiere Datum fÃ¼r Dateinamen
          BACKUP_DATE=$(date +%Y-%m-%d_%H-%M-%S)
          BACKUP_FILE="backup_aismarthack_${BACKUP_DATE}.sql"
          
          echo "ðŸ”„ Starte Datenbank-Backup..."
          
          # pg_dump mit Connection String
          pg_dump "${SUPABASE_DB_URL}" \
            --no-owner \
            --no-acl \
            --clean \
            --if-exists \
            -f "${BACKUP_FILE}"
          
          echo "âœ… Backup erstellt: ${BACKUP_FILE}"
          
          # Komprimieren
          gzip "${BACKUP_FILE}"
          BACKUP_FILE="${BACKUP_FILE}.gz"
          
          echo "ðŸ“¦ Backup komprimiert: ${BACKUP_FILE}"
          ls -lh "${BACKUP_FILE}"
          
          # FÃ¼r Upload-Step verfÃ¼gbar machen
          echo "BACKUP_FILE=${BACKUP_FILE}" >> $GITHUB_ENV

      - name: Upload Backup Artifact
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ github.run_number }}
          path: ${{ env.BACKUP_FILE }}
          retention-days: 30
          compression-level: 0  # Bereits komprimiert

      - name: Cleanup Old Runs (Artifacts)
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            
            // Hole alle Workflow-Runs
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: 'backup.yml',
              status: 'completed',
              per_page: 100
            });
            
            // Berechne 30-Tage-Grenze
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            // LÃ¶sche alte Runs (und damit ihre Artifacts)
            for (const run of runs.data.workflow_runs) {
              const runDate = new Date(run.created_at);
              if (runDate < thirtyDaysAgo) {
                console.log(`ðŸ—‘ï¸ LÃ¶sche alten Run vom ${run.created_at}`);
                await github.rest.actions.deleteWorkflowRun({
                  owner,
                  repo,
                  run_id: run.id
                });
              }
            }
            
            console.log('âœ… Cleanup abgeschlossen');

  notify-failure:
    runs-on: ubuntu-latest
    needs: backup
    if: failure()
    steps:
      - name: Notify on Failure
        run: |
          echo "âš ï¸ Backup fehlgeschlagen!"
          echo "Bitte prÃ¼fe die Workflow-Logs."
          # Hier kÃ¶nnte ein Webhook/Email-Notification eingebaut werden
          exit 0
