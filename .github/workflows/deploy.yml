name: Production Deploy (Self-Hosted)

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: self-hosted  # WICHTIG: Das leitet es auf DEINEN Server
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Wir erstellen die .env Datei dynamisch aus den Secrets, die du gerade angelegt hast
      - name: Create .env.local
        run: |
          echo "NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" > .env.local
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" >> .env.local
          echo "RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}" >> .env.local

      # Build des Docker Images direkt auf deinem Server
      - name: Build Docker Image
        run: docker build -t aismarthack-app:latest .

      # Starten des Containers
      - name: Start Container
        run: |
          # Alten Container stoppen (falls er läuft), Fehler ignorieren wenn nicht
          docker stop nextjs-app || true
          docker rm nextjs-app || true
          
          # Neuen Container starten
          # Port 3000 wird intern geöffnet
          docker run -d \
            --name nextjs-app \
            --restart unless-stopped \
            -p 3000:3000 \
            --env-file .env.local \
            aismarthack-app:latest

      # Aufräumen (damit die Festplatte nicht voll läuft)
      - name: Prune Docker
        run: docker system prune -f
